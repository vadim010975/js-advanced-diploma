!function(){"use strict";function e(e,t){switch(!0){case 0===e:return"top-left";case e===t-1:return"top-right";case e===t*(t-1):return"bottom-left";case e===t*t-1:return"bottom-right";case e>0&&e<t:return"top";case e%t==0:return"left";case(e+1)%t==0:return"right";case e>t*(t-1)&&e<t*t-1:return"bottom";default:return"center"}}class t{constructor(){this.boardSize=8,this.container=null,this.boardEl=null,this.cells=[],this.cellClickListeners=[],this.cellDblClickListeners=[],this.cellEnterListeners=[],this.cellLeaveListeners=[],this.newGameListeners=[],this.saveGameListeners=[],this.loadGameListeners=[],this.popupClosedListeners=[]}bindToDOM(e){if(!(e instanceof HTMLElement))throw new Error("container is not HTMLElement");this.container=e}drawUi(t){this.checkBinding(),this.container.innerHTML='\n      <div class="controls">\n        <div id=\'score\' class="controls-info">Score: </div>\n        <div id=\'max-score\' class="controls-info">MaxScore: </div>\n        <button data-id="action-restart" class="btn">New Game</button>\n        <button data-id="action-save" class="btn">Save Game</button>\n        <button data-id="action-load" class="btn">Load Game</button>\n        <div id=\'round\' class="controls-info">Round: </div>\n      </div>\n      <div class="board-container">\n        <div data-id="board" class="board"></div>\n      </div>\n      <div class="controls">\n        <div class="controls-info">Двойной клик ЛКМ - длинная атака</div>\n      </div>\n    ',this.newGameEl=this.container.querySelector("[data-id=action-restart]"),this.saveGameEl=this.container.querySelector("[data-id=action-save]"),this.loadGameEl=this.container.querySelector("[data-id=action-load]"),this.scoreEl=this.container.querySelector("#score"),this.maxScoreEl=this.container.querySelector("#max-score"),this.roundEl=this.container.querySelector("#round"),this.popupEl=document.querySelector(".popup"),this.popupClosedEl=document.querySelector(".popup-closed"),this.popupClosedEl.style.cursor="pointer",this.newGameEl.addEventListener("click",(e=>this.onNewGameClick(e))),this.saveGameEl.addEventListener("click",(e=>this.onSaveGameClick(e))),this.loadGameEl.addEventListener("click",(e=>this.onLoadGameClick(e))),this.popupClosedEl.addEventListener("click",(e=>this.onPopupClosed(e))),this.boardEl=this.container.querySelector("[data-id=board]"),this.boardEl.classList.add(t);for(let t=0;t<this.boardSize**2;t+=1){const a=document.createElement("div");a.classList.add("cell","map-tile",`map-tile-${e(t,this.boardSize)}`),a.addEventListener("mouseenter",(e=>this.onCellEnter(e))),a.addEventListener("mouseleave",(e=>this.onCellLeave(e))),a.addEventListener("click",(e=>this.onCellClick(e))),a.addEventListener("dblclick",(e=>this.onCellDblClick(e))),this.boardEl.appendChild(a)}this.cells=Array.from(this.boardEl.children)}redrawPositions(e){this.cells.forEach((e=>{e.innerHTML=""})),e.forEach((e=>{const t=this.boardEl.children[e.position],a=document.createElement("div");a.classList.add("character",e.character.type),a.dataset.level=e.character.level,a.dataset.attack=e.character.attack,a.dataset.defence=e.character.defence,a.dataset.health=e.character.health,a.dataset.id=e.character.id;const s=document.createElement("div");s.classList.add("health-level");const i=document.createElement("div");var r;i.classList.add("health-level-indicator","health-level-indicator-"+((r=e.character.health)<15?"critical":r<50?"normal":"high")),i.style.width=`${e.character.health}%`,s.appendChild(i),a.appendChild(s),t.appendChild(a)}))}addCellEnterListener(e){this.cellEnterListeners.push(e)}addCellLeaveListener(e){this.cellLeaveListeners.push(e)}addCellClickListener(e){this.cellClickListeners.push(e)}addCellDblClickListener(e){this.cellDblClickListeners.push(e)}addNewGameListener(e){this.newGameListeners.push(e)}addSaveGameListener(e){this.saveGameListeners.push(e)}addLoadGameListener(e){this.loadGameListeners.push(e)}addPopupClosedListener(e){this.popupClosedListeners.push(e)}onCellEnter(e){e.preventDefault();const t=this.cells.indexOf(e.currentTarget);this.cellEnterListeners.forEach((e=>e.call(null,t)))}onCellLeave(e){e.preventDefault();const t=this.cells.indexOf(e.currentTarget);this.cellLeaveListeners.forEach((e=>e.call(null,t)))}onCellClick(e){const t=this.cells.indexOf(e.currentTarget);this.cellClickListeners.forEach((e=>e.call(null,t)))}onCellDblClick(e){const t=this.cells.indexOf(e.currentTarget);this.cellDblClickListeners.forEach((e=>e.call(null,t)))}onNewGameClick(e){e.preventDefault(),this.newGameListeners.forEach((e=>e.call(null)))}onSaveGameClick(e){e.preventDefault(),this.saveGameListeners.forEach((e=>e.call(null)))}onLoadGameClick(e){e.preventDefault(),this.loadGameListeners.forEach((e=>e.call(null)))}onPopupClosed(e){e.preventDefault(),this.popupClosedListeners.forEach((e=>e.call(null)))}static showError(e){document.querySelector(".popup-title").textContent=e,document.querySelector(".popup").style.display=""}static showMessage(e){document.querySelector(".popup-title").textContent=e,document.querySelector(".popup").style.display=""}hidePopup(){this.popupEl.style.display="none"}selectCell(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"yellow";this.deselectCell(e),this.cells[e].classList.add("selected",`selected-${t}`)}deselectCell(e){const t=this.cells[e];t.classList.remove(...Array.from(t.classList).filter((e=>e.startsWith("selected"))))}showCellTooltip(e,t){this.cells[t].title=e}hideCellTooltip(e){this.cells[e].title=""}showDamage(e,t){return new Promise((a=>{const s=this.cells[e],i=document.createElement("span");i.textContent=t,i.classList.add("damage"),s.appendChild(i),i.addEventListener("animationend",(()=>{s.removeChild(i),a()}))}))}setCursor(e){this.boardEl.style.cursor=e}checkBinding(){if(null===this.container)throw new Error("GamePlay not bind to DOM")}}class a{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"generic";if("Character"===this.constructor.name)throw new Error("Конструктор new Character() запрещен для вызова!");this.level=e,this.attack=0,this.defence=0,this.health=50,this.type=t}levelUp(){let e=40;1===this.level&&(e=80),this.attack=Math.round(Math.max(1.2*this.attack,this.attack*((e+this.health)/100))),this.defence=Math.round(Math.max(1.2*this.defence,this.defence*((e+this.health)/100))),this.health=Math.round(Math.min(this.health+80,100)),this.level+=1}}class s extends a{constructor(e){super(e,"bowman"),this.attack=40,this.defence=25}}class i extends a{constructor(e){super(e,"daemon"),this.attack=20,this.defence=40}}class r extends a{constructor(e){super(e,"magician"),this.attack=20,this.defence=40}}class l extends a{constructor(e){super(e,"swordsman"),this.attack=60,this.defence=10}}class n extends a{constructor(e){super(e,"undead"),this.attack=60,this.defence=10}}class c extends a{constructor(e){super(e,"vampire"),this.attack=40,this.defence=25}}class o{constructor(e){this.characters=e}}class h{constructor(e,t){if(!(e instanceof a))throw new Error("character must be instance of Character or its children");if("number"!=typeof t)throw new Error("position must be a number");this.character=e,this.position=t}}function d(e,t,a){const s=[],i=function*(e,t){for(;;){const a=new(e[Math.floor(Math.random()*e.length)])(1),s=Math.ceil(Math.random()*t);if(s>1)for(let e=1;e<s;e+=1)a.levelUp();yield a}}(e,t);for(let e=0;e<a;e+=1)s.push(i.next().value);return new o(s)}function m(e,t){const a=[];return e.characters.forEach((e=>{const s=Math.floor(t.length*Math.random());a.push(new h(e,t[s])),t.splice(s,1)})),a}var u="auto",y="pointer",g="crosshair",p="not-allowed";class C{constructor(e){const t=e.querySelector(".character");t?(this.isEmpty=!1,this.charEl=t,t.classList.contains("swordsman")?(this.character="swordsman",this.charHikeRange=4,this.charAttackRange=1):t.classList.contains("bowman")?(this.character="bowman",this.charHikeRange=2,this.charAttackRange=2):t.classList.contains("magician")?(this.character="magician",this.charHikeRange=1,this.charAttackRange=4):t.classList.contains("undead")?(this.character="undead",this.charHikeRange=4,this.charAttackRange=1):t.classList.contains("vampire")?(this.character="vampire",this.charHikeRange=2,this.charAttackRange=2):t.classList.contains("daemon")&&(this.character="daemon",this.charHikeRange=1,this.charAttackRange=4),this.role="swordsman"===this.character||"bowman"===this.character||"magician"===this.character?"ally":"enemy",e.classList.contains("selected")&&(this.isSelected=!0)):(this.isEmpty=!0,this.character=null,this.charEl=null,this.role=null,this.isSelected=!1,this.charHikeRange=0,this.charAttackRange=0)}}class P{constructor(e){for(let t=0;t<e.length;t+=1){const{character:s}=e[t];Object.prototype.hasOwnProperty.call(s,"id")?Object.setPrototypeOf(s,a.prototype):s.id=t+1,this[`teamMember${s.id}`]={character:s,position:e[t].position}}}getPositionedCharacters(){const e=[];return Object.values(this).forEach((t=>{e.push(new h(t.character,t.position))})),e}setNewPosition(e,t){Object.keys(this).forEach((a=>{+this[a].character.id==+e&&(this[a].position=t)}))}getTarget(){return this.getPositionedCharacters().reduce(((e,t)=>t.character.defence<e[0]?[t.character.defence,t.character.id]:e),[500,{}])[1]}setDamage(e,t,a){const s=Math.trunc(Math.max(t-this[`teamMember${e}`].character.defence,.1*t));this[`teamMember${e}`].character.health-=s,this[`teamMember${e}`].character.health<=0?(a(!0),delete this[`teamMember${e}`]):a(!1)}teamLevelUp(){const e=[];return Object.values(this).forEach((t=>{t.character.levelUp(),e.push(t.character)})),{characters:e}}getScore(){let e=0;return Object.values(this).forEach((t=>{e+=t.character.attack+t.character.defence})),e}}class v{constructor(e){for(let t=0;t<e.length;t+=1){const{character:s}=e[t];Object.prototype.hasOwnProperty.call(s,"id")?Object.setPrototypeOf(s,a.prototype):s.id=t+11,this[`teamMember${s.id}`]={character:s,position:e[t].position}}}getPositionedCharacters(){const e=[];return Object.values(this).forEach((t=>{e.push(new h(t.character,t.position))})),e}setDamage(e,t,a){const s=Math.trunc(Math.max(t-this[`teamMember${e}`].character.defence,.1*t));this[`teamMember${e}`].character.health-=s,this[`teamMember${e}`].character.health<=0&&(a(this[`teamMember${e}`].character.defence),delete this[`teamMember${e}`])}setNewPosition(e,t){Object.keys(this).forEach((a=>{+this[a].character.id==+e&&(this[a].position=t)}))}getAtteckerId(){const e=this.getPositionedCharacters().filter((e=>"daemon"===e.character.type)),t=this.getPositionedCharacters().filter((e=>"vampire"===e.character.type)),a=this.getPositionedCharacters().filter((e=>"undead"===e.character.type));let s;return s=0===e.length&&0===t.length?a:0===e.length&&0!==t.length?t:e,s.reduce(((e,t)=>t.character.attack>e[0]?[t.character.attack,t.character.id]:e),[0,{}])[1]}static teamLevelUp(e,t){let a;return a=d([i,n,c],e<3?2:1,t),{characters:a.characters.map((t=>{const a=t;let s=1;return 3===e&&(s=1.5,a.health=100),4===e&&(s=2,a.health=100),a.attack*=s,a.defence*=s,a.level=e,a}))}}}function f(e,t){return e.concat(t)}class w{static activePlayer;static round;static maxScore=0;static ownTeam=[];static enemyTeam=[];static score=0;static theme=null;static indexAutoAttack=null;static indexAutoAttacker=null;static enemysLastTarget=null;static from(e){return this.activePlayer=e.activePlayer,this.round=e.round,this.maxScore=e.maxScore,this.ownTeam=e.ownTeam,this.enemyTeam=e.enemyTeam,this.theme=e.theme,this.score=e.score,null}static getData(){return{activePlayer:this.activePlayer,round:this.round,score:this.score,maxScore:this.maxScore,ownTeam:this.ownTeam,enemyTeam:this.enemyTeam,theme:this.theme}}static setMaxScore(){this.score>this.maxScore&&(this.maxScore=this.score)}static addPoints(e){this.score+=e}}class k{constructor(e){this.boardSize=e;const t=[];for(let e=0;e<this.boardSize;e+=1){t[e]=[];for(let a=0;a<this.boardSize;a+=1)t[e][a]=a+e*this.boardSize}this.arrayIndexes=t}getIndexes(e){for(let t=0;t<this.boardSize;t+=1)for(let a=0;a<this.boardSize;a+=1)if(this.arrayIndexes[t][a]===e)return[t,a]}}var L={prairie:"prairie",desert:"desert",arctic:"arctic",mountain:"mountain"};class b{constructor(e,t){this.gamePlay=e,this.stateService=t,this.selectedCellIdx=null,this.countCharacterInTeam=4,this.ownTeam={},this.enemyTeam={}}init(){w.round=1,this.setTheme(),this.ownTeam=new P(m(d([s,l,r],2,this.countCharacterInTeam),[0,1,8,9,16,17,24,25,32,33,40,41,48,49,56,57])),this.enemyTeam=new v(m(d([i,n,c],2,this.countCharacterInTeam),[6,7,14,15,22,23,30,31,38,39,46,47,54,55,62,63])),this.gamePlay.redrawPositions(f(this.ownTeam.getPositionedCharacters(),this.enemyTeam.getPositionedCharacters())),this.gamePlay.addCellEnterListener((e=>this.onCellEnter(e))),this.gamePlay.addCellLeaveListener((e=>this.onCellLeave(e))),this.gamePlay.addCellClickListener((e=>this.onCellClick(e))),this.gamePlay.addCellDblClickListener((e=>this.onCellDblClick(e))),this.gamePlay.addNewGameListener((()=>this.startNewGame())),this.gamePlay.addSaveGameListener((()=>this.saveGame())),this.gamePlay.addLoadGameListener((()=>this.loadGame())),this.gamePlay.addPopupClosedListener((()=>this.onPopupClosed())),this.showInfo(),w.activePlayer=0,this.play()}setTheme(){let{theme:e}=w;if(e){let t=Object.values(L).findIndex((e=>e===w.theme));t>=Object.values(L).length-1&&(t=-1),e=Object.values(L)[t+1]}else[e]=Object.values(L);w.theme=e,this.gamePlay.drawUi(e)}play(){w.ownTeam=this.ownTeam.getPositionedCharacters(),w.enemyTeam=this.enemyTeam.getPositionedCharacters(),this.enemyTeam.getPositionedCharacters().length?this.ownTeam.getPositionedCharacters().length?1===w.activePlayer?this.reactEnemy():0===w.activePlayer&&null!==w.indexAutoAttack&&this.checkAttack(w.indexAutoAttack):(t.showMessage("вы проиграли"),this.blockGame()):4===w.round?(t.showMessage("вы выиграли игру"),w.setMaxScore(),this.showInfo(),this.blockGame()):(w.addPoints(this.ownTeam.getScore()),this.startNewRound())}onCellClick(e){null!==this.selectedCellIdx&&this.gamePlay.deselectCell(this.selectedCellIdx);const a=new C(this.gamePlay.cells[e]);"ally"===a.role?(this.gamePlay.selectCell(e),this.selectedCellIdx=e):a.isEmpty&&this.getIndexesMoveAndAttack(this.selectedCellIdx).arrayMoveIndexes.includes(e)?this.move(e):"enemy"===a.role&&this.getIndexesMoveAndAttack(this.selectedCellIdx).arrayAttackIndexes.includes(e)?this.attack(e):t.showError("Не правильный выбор!")}onCellDblClick(e){w.indexAutoAttack=e,w.indexAutoAttacker=this.selectedCellIdx,this.play()}onCellEnter(e){if(1===w.activePlayer)return;const t=new C(this.gamePlay.cells[e]);if(t.isEmpty)null!==this.selectedCellIdx?this.getIndexesMoveAndAttack(this.selectedCellIdx).arrayMoveIndexes.includes(e)?(this.gamePlay.setCursor(y),this.gamePlay.selectCell(e,"green")):this.gamePlay.setCursor(p):this.gamePlay.setCursor(u);else{const a=b.showInformation(t.charEl);this.gamePlay.showCellTooltip(a,e),"ally"===t.role?(this.showAttackAndMovementBoundaries(e),t.isSelected||this.gamePlay.setCursor(y)):null!==this.selectedCellIdx&&"enemy"===t.role?this.getIndexesMoveAndAttack(this.selectedCellIdx).arrayAttackIndexes.includes(e)?(this.gamePlay.setCursor(g),this.gamePlay.selectCell(e,"red")):this.gamePlay.setCursor(p):this.gamePlay.setCursor(u)}}onCellLeave(e){const t=new C(this.gamePlay.cells[e]);t.isEmpty||(this.gamePlay.hideCellTooltip(e),"ally"===t.role&&this.hideAttackAndMovementBoundaries()),this.gamePlay.setCursor(u),t.isSelected&&"ally"===t.role||this.gamePlay.deselectCell(e)}onPopupClosed(){this.gamePlay.hidePopup()}static showInformation(e){return`🎖${e.dataset.level} ⚔${e.dataset.attack} 🛡${e.dataset.defence} ❤${e.dataset.health}`}move(e){const t=this.gamePlay.cells[this.selectedCellIdx].querySelector(".character").dataset.id,a=function*(e){const a=new k(this.gamePlay.boardSize),{arrayIndexes:s}=new k(this.gamePlay.boardSize);let[i,r]=a.getIndexes(this.selectedCellIdx);const[l,n]=a.getIndexes(e),c=l-i,o=n-r,h=Math.max(Math.abs(o),Math.abs(c));for(let e=0;e<h;e+=1){const e=Math.trunc(i+c/h),a=Math.trunc(r+o/h);e>=0&&e<this.gamePlay.boardSize&&a>=0&&a<this.gamePlay.boardSize&&(i=e,r=a),0===w.activePlayer&&(this.ownTeam.setNewPosition(t,s[i][r]),yield this.ownTeam.getPositionedCharacters()),1===w.activePlayer&&(this.enemyTeam.setNewPosition(t,s[i][r]),yield this.enemyTeam.getPositionedCharacters())}}.call(this,e);let s;const i=()=>{setTimeout((()=>{s=a.next(),s.done?(this.gamePlay.deselectCell(e),w.activePlayer=0===w.activePlayer?1:0,this.play()):(0===w.activePlayer&&this.gamePlay.redrawPositions(f(s.value,this.enemyTeam.getPositionedCharacters())),1===w.activePlayer&&this.gamePlay.redrawPositions(f(this.ownTeam.getPositionedCharacters(),s.value)),i())}),50)};i()}attack(e){const{attack:t}=this.gamePlay.cells[this.selectedCellIdx].querySelector(".character").dataset;this.gamePlay.selectCell(this.selectedCellIdx),this.gamePlay.selectCell(e,"red"),this.gamePlay.showDamage(e,t).then((()=>{0===w.activePlayer&&(this.enemyTeam.setDamage(this.gamePlay.cells[e].querySelector(".character").dataset.id,t,(e=>{w.addPoints(e)})),this.showInfo(),this.gamePlay.redrawPositions(f(this.ownTeam.getPositionedCharacters(),this.enemyTeam.getPositionedCharacters()))),1===w.activePlayer&&(w.enemysLastTarget=e,this.ownTeam.setDamage(this.gamePlay.cells[e].querySelector(".character").dataset.id,t,(e=>{e&&(w.enemysLastTarget="killed")})),this.gamePlay.redrawPositions(f(this.ownTeam.getPositionedCharacters(),this.enemyTeam.getPositionedCharacters()))),this.gamePlay.deselectCell(this.selectedCellIdx),this.gamePlay.deselectCell(e),w.activePlayer=0===w.activePlayer?1:0,this.play()}))}reactEnemy(){const e=this.ownTeam.getTarget(),t=this.gamePlay.boardEl.querySelector(`[data-id="${e}"]`),a=this.gamePlay.cells.indexOf(t.closest(".cell")),s=this.enemyTeam.getAtteckerId(),i=this.gamePlay.boardEl.querySelector(`[data-id="${s}"]`),r=this.gamePlay.cells.indexOf(i.closest(".cell"));this.selectedCellIdx=r,this.getIndexesMoveAndAttack(r).arrayAttackIndexes.includes(a)?this.attack(a,i.attack):this.chooseDirection(a)}chooseDirection(e){const t=new k(this.gamePlay.boardSize),{arrayIndexes:a}=new k(this.gamePlay.boardSize),[s,i]=t.getIndexes(e),[r,l]=t.getIndexes(this.selectedCellIdx),n=new C(this.gamePlay.cells[this.selectedCellIdx]).charAttackRange;let c=Math.sign(s-r),o=Math.sign(i-l);const h=new C(this.gamePlay.cells[this.selectedCellIdx]).charHikeRange,d=function*(e,t){e&&t&&(yield[0,t],yield[e,0],yield[-1*e,t],yield[e,-1*t]),e&&!t&&(yield[e,-1],yield[e,1],yield[0,-1],yield[0,1]),!e&&t&&(yield[-1,t],yield[1,t],yield[-1,0],yield[1,0])}(c,o);let m,u=r,y=l;for(let t=0;t<h&&(u+=c,y+=o,!(u>=0&&u<this.gamePlay.boardSize&&y>=0&&y<this.gamePlay.boardSize&&(m=t+1,this.getIndexesMoveAndAttack(a[u][y],n).arrayAttackIndexes.includes(e))));t+=1);for(;!new C(this.gamePlay.cells[a[r+c*m][l+o*m]]).isEmpty;){if(1===m){const[e,t]=d.next().value,a=r+e*m,s=l+t*m;a>=0&&a<this.gamePlay.boardSize&&s>=0&&s<this.gamePlay.boardSize&&([c,o]=[e,t])}m>1&&(m-=1)}const g=a[r+c*m][l+o*m];this.move(g)}getIndexesMoveAndAttack(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:NaN;const a=new k(this.gamePlay.boardSize),s=a.arrayIndexes,[i,r]=a.getIndexes(e),l=new C(this.gamePlay.cells[e]),n=l.charHikeRange,c=[];for(let e=1;e<=n;e+=1)c.push(s[i][r-e]),c.push(s[i][r+e]),i-e>=0&&(c.push(s[i-e][r]),c.push(s[i-e][r-e]),c.push(s[i-e][r+e])),i+e<s.length&&(c.push(s[i+e][r]),c.push(s[i+e][r+e]),c.push(s[i+e][r-e]));const o=t||l.charAttackRange,h=[],d=i-o<0?0:i-o,m=r-o<0?0:r-o,u=i+o>=s.length?s.length-1:i+o,y=r+o>=s.length?s.length-1:r+o;for(let e=d;e<=u;e+=1)for(let t=m;t<=y;t+=1)h.push(s[e][t]);return{arrayMoveIndexes:c.filter((e=>void 0!==e)),arrayAttackIndexes:h}}checkAttack(e){const t=new C(this.gamePlay.cells[e]),a=new C(this.gamePlay.cells[this.selectedCellIdx]);if(t.isEmpty||"enemy"!==t.role||a.isEmpty||"killed"===w.enemysLastTarget)return w.indexAutoAttack=null,w.indexAutoAttacker=null,void(w.enemysLastTarget=null);this.selectedCellIdx=w.indexAutoAttacker,this.attack(e)}startNewRound(){w.round+=1,this.setTheme(),this.ownTeam=new P(m(this.ownTeam.teamLevelUp(),[0,1,8,9,16,17,24,25,32,33,40,41,48,49,56,57])),this.enemyTeam=new v(m(v.teamLevelUp(w.round,this.countCharacterInTeam),[6,7,14,15,22,23,30,31,38,39,46,47,54,55,62,63])),w.ownTeam=this.ownTeam.getPositionedCharacters(),w.enemyTeam=this.enemyTeam.getPositionedCharacters(),this.gamePlay.redrawPositions(f(this.ownTeam.getPositionedCharacters(),this.enemyTeam.getPositionedCharacters())),this.showInfo(),w.activePlayer=0}blockGame(){this.gamePlay.addCellEnterListener((()=>{this.gamePlay.cellEnterListeners=[]})),this.gamePlay.addCellLeaveListener((()=>{this.gamePlay.cellLeaveListeners=[]})),this.gamePlay.addCellClickListener((()=>{this.gamePlay.cellClickListeners=[]}))}startNewGame(){this.gamePlay=new t,this.gamePlay.bindToDOM(document.querySelector("#game-container")),w.score=0,this.init()}saveGame(){this.stateService.save(w.getData())}loadGame(){try{w.from(this.stateService.load()),this.ownTeam=new P(w.ownTeam),this.enemyTeam=new v(w.enemyTeam),this.gamePlay.drawUi(w.theme),this.gamePlay.redrawPositions(f(this.ownTeam.getPositionedCharacters(),this.enemyTeam.getPositionedCharacters())),this.showInfo()}catch(e){t.showError(e.message)}}showInfo(){this.gamePlay.scoreEl.textContent=`Score: ${w.score}`,this.gamePlay.maxScoreEl.textContent=`MaxScore: ${w.maxScore}`,this.gamePlay.roundEl.textContent=`Round: ${w.round}`}showAttackAndMovementBoundaries(e){const t=this.getIndexesMoveAndAttack(e).arrayMoveIndexes,a=this.getIndexesMoveAndAttack(e).arrayAttackIndexes;t.forEach((e=>{this.gamePlay.cells[e].classList.add("move")})),a.forEach((e=>{const t=function(e,t,a){const s=Math.min(...t),i=Math.max(...t);if(e===s)return"top-left";if(e===i)return"bottom-right";let r=s+a;for(;r<i-a;){if(e===r)return"left";r+=a}const l=r;if(e===l)return"bottom-left";for(r=i-a;r>s+a;){if(e===r)return"right";r-=a}return e===r?"top-right":e>s&&e<r?"top":e>l&&e<i?"bottom":void 0}(e,a,this.gamePlay.boardSize);t&&this.gamePlay.cells[e].classList.add("border",`border-${t}`)}))}hideAttackAndMovementBoundaries(){this.gamePlay.cells.forEach((e=>{e.classList.remove("move"),e.classList.remove("border");const t=[...e.classList].find((e=>e.startsWith("border-")));t&&e.classList.remove(t)}))}}const x=new t;x.bindToDOM(document.querySelector("#game-container"));const E=new class{constructor(e){this.storage=e}save(e){this.storage.setItem("state",JSON.stringify(e))}load(){try{return JSON.parse(this.storage.getItem("state"))}catch(e){throw new Error("Invalid state")}}}(localStorage);new b(x,E).init()}();