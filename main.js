!function(){"use strict";function e(e,t){switch(!0){case 0===e:return"top-left";case e===t-1:return"top-right";case e===t*(t-1):return"bottom-left";case e===t*t-1:return"bottom-right";case e>0&&e<t:return"top";case e%t==0:return"left";case(e+1)%t==0:return"right";case e>t*(t-1)&&e<t*t-1:return"bottom";default:return"center"}}class t{constructor(){this.boardSize=8,this.container=null,this.boardEl=null,this.cells=[],this.cellClickListeners=[],this.cellDblClickListeners=[],this.cellEnterListeners=[],this.cellLeaveListeners=[],this.newGameListeners=[],this.saveGameListeners=[],this.loadGameListeners=[],this.popupClosedListeners=[]}bindToDOM(e){if(!(e instanceof HTMLElement))throw new Error("container is not HTMLElement");this.container=e}drawUi(t){this.checkBinding(),this.container.innerHTML='\n      <div class="controls">\n        <div id=\'score\' class="controls-info">Score: </div>\n        <div id=\'max-score\' class="controls-info">MaxScore: </div>\n        <button data-id="action-restart" class="btn">New Game</button>\n        <button data-id="action-save" class="btn">Save Game</button>\n        <button data-id="action-load" class="btn">Load Game</button>\n        <div id=\'round\' class="controls-info">Round: </div>\n      </div>\n      <div class="board-container">\n        <div data-id="board" class="board"></div>\n      </div>\n      <div class="controls">\n        <div class="controls-info">Двойной клик ЛКМ - длинная атака</div>\n      </div>\n    ',this.newGameEl=this.container.querySelector("[data-id=action-restart]"),this.saveGameEl=this.container.querySelector("[data-id=action-save]"),this.loadGameEl=this.container.querySelector("[data-id=action-load]"),this.scoreEl=this.container.querySelector("#score"),this.maxScoreEl=this.container.querySelector("#max-score"),this.roundEl=this.container.querySelector("#round"),this.popupEl=document.querySelector(".popup"),this.popupClosedEl=document.querySelector(".popup-closed"),this.popupClosedEl.style.cursor="pointer",this.newGameEl.addEventListener("click",(e=>this.onNewGameClick(e))),this.saveGameEl.addEventListener("click",(e=>this.onSaveGameClick(e))),this.loadGameEl.addEventListener("click",(e=>this.onLoadGameClick(e))),this.popupClosedEl.addEventListener("click",(e=>this.onPopupClosed(e))),this.boardEl=this.container.querySelector("[data-id=board]"),this.boardEl.classList.add(t);for(let t=0;t<this.boardSize**2;t+=1){const a=document.createElement("div");a.classList.add("cell","map-tile",`map-tile-${e(t,this.boardSize)}`),a.addEventListener("mouseenter",(e=>this.onCellEnter(e))),a.addEventListener("mouseleave",(e=>this.onCellLeave(e))),a.addEventListener("click",(e=>this.onCellClick(e))),a.addEventListener("dblclick",(e=>this.onCellDblClick(e))),this.boardEl.appendChild(a)}this.cells=Array.from(this.boardEl.children)}redrawPositions(e){this.cells.forEach((e=>{e.innerHTML=""})),e.forEach((e=>{const t=this.boardEl.children[e.position],a=document.createElement("div");a.classList.add("character",e.character.type),a.dataset.level=e.character.level,a.dataset.attack=e.character.attack,a.dataset.defence=e.character.defence,a.dataset.health=e.character.health,a.dataset.id=e.character.id;const s=document.createElement("div");s.classList.add("health-level");const i=document.createElement("div");var r;i.classList.add("health-level-indicator","health-level-indicator-"+((r=e.character.health)<15?"critical":r<50?"normal":"high")),i.style.width=`${e.character.health}%`,s.appendChild(i),a.appendChild(s),t.appendChild(a)}))}addCellEnterListener(e){this.cellEnterListeners.push(e)}addCellLeaveListener(e){this.cellLeaveListeners.push(e)}addCellClickListener(e){this.cellClickListeners.push(e)}addCellDblClickListener(e){this.cellDblClickListeners.push(e)}addNewGameListener(e){this.newGameListeners.push(e)}addSaveGameListener(e){this.saveGameListeners.push(e)}addLoadGameListener(e){this.loadGameListeners.push(e)}addPopupClosedListener(e){this.popupClosedListeners.push(e)}onCellEnter(e){e.preventDefault();const t=this.cells.indexOf(e.currentTarget);this.cellEnterListeners.forEach((e=>e.call(null,t)))}onCellLeave(e){e.preventDefault();const t=this.cells.indexOf(e.currentTarget);this.cellLeaveListeners.forEach((e=>e.call(null,t)))}onCellClick(e){const t=this.cells.indexOf(e.currentTarget);this.cellClickListeners.forEach((e=>e.call(null,t)))}onCellDblClick(e){const t=this.cells.indexOf(e.currentTarget);this.cellDblClickListeners.forEach((e=>e.call(null,t)))}onNewGameClick(e){e.preventDefault(),this.newGameListeners.forEach((e=>e.call(null)))}onSaveGameClick(e){e.preventDefault(),this.saveGameListeners.forEach((e=>e.call(null)))}onLoadGameClick(e){e.preventDefault(),this.loadGameListeners.forEach((e=>e.call(null)))}onPopupClosed(e){e.preventDefault(),this.popupClosedListeners.forEach((e=>e.call(null)))}static showError(e){document.querySelector(".popup-title").textContent=e,document.querySelector(".popup").style.display=""}static showMessage(e){document.querySelector(".popup-title").textContent=e,document.querySelector(".popup").style.display=""}hidePopup(){this.popupEl.style.display="none"}selectCell(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"yellow";this.deselectCell(e),this.cells[e].classList.add("selected",`selected-${t}`)}deselectCell(e){if(null==e)return;const t=this.cells[e];t.classList.remove(...Array.from(t.classList).filter((e=>e.startsWith("selected"))))}showCellTooltip(e,t){this.cells[t].title=e}hideCellTooltip(e){this.cells[e].title=""}showDamage(e,t){return new Promise((a=>{const s=this.cells[e],i=document.createElement("span");i.textContent=t,i.classList.add("damage"),s.appendChild(i),i.addEventListener("animationend",(()=>{s.removeChild(i),a()}))}))}setCursor(e){this.boardEl.style.cursor=e}checkBinding(){if(null===this.container)throw new Error("GamePlay not bind to DOM")}}class a{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"generic";if("Character"===this.constructor.name)throw new Error("Конструктор new Character() запрещен для вызова!");this.level=e,this.attack=0,this.defence=0,this.health=50,this.type=t}levelUp(){let e=40;1===this.level&&(e=80),this.attack=Math.round(Math.max(1.2*this.attack,this.attack*((e+this.health)/100))),this.defence=Math.round(Math.max(1.2*this.defence,this.defence*((e+this.health)/100))),this.health=Math.round(Math.min(this.health+80,100)),this.level+=1}}class s extends a{constructor(e){super(e,"bowman"),this.attack=40,this.defence=25,this.charHikeRange=2,this.charAttackRange=2}}class i extends a{constructor(e){super(e,"daemon"),this.attack=20,this.defence=40,this.charHikeRange=1,this.charAttackRange=4}}class r extends a{constructor(e){super(e,"magician"),this.attack=20,this.defence=40,this.charHikeRange=1,this.charAttackRange=4}}class n extends a{constructor(e){super(e,"swordsman"),this.attack=60,this.defence=10,this.charHikeRange=4,this.charAttackRange=1}}class l extends a{constructor(e){super(e,"undead"),this.attack=60,this.defence=10,this.charHikeRange=4,this.charAttackRange=1}}class h extends a{constructor(e){super(e,"vampire"),this.attack=40,this.defence=25,this.charHikeRange=2,this.charAttackRange=2}}class c{constructor(e){this.characters=e}}class o{constructor(e,t){if(!(e instanceof a))throw new Error("character must be instance of Character or its children");if("number"!=typeof t)throw new Error("position must be a number");this.character=e,this.position=t}}function d(e,t,a){const s=[],i=function*(e,t){for(;;){const a=new(e[Math.floor(Math.random()*e.length)])(1),s=Math.ceil(Math.random()*t);if(s>1)for(let e=1;e<s;e+=1)a.levelUp();yield a}}(e,t);for(let e=0;e<a;e+=1)s.push(i.next().value);return new c(s)}function m(e,t){const a=[];return e.characters.forEach((e=>{const s=Math.floor(t.length*Math.random());a.push(new o(e,t[s])),t.splice(s,1)})),a}var g="auto",u="pointer",y="crosshair",S="not-allowed";class p{constructor(e){for(let t=0;t<e.length;t+=1){const{character:s}=e[t];Object.prototype.hasOwnProperty.call(s,"id")?Object.setPrototypeOf(s,a.prototype):s.id=t+1,this[`teamMember${s.id}`]={character:s,position:e[t].position}}}getPositionedCharacters(){const e=[];return Object.values(this).forEach((t=>{e.push(new o(t.character,t.position))})),e}setNewPosition(e,t){Object.keys(this).forEach((a=>{+this[a].character.id==+e&&(this[a].position=t)}))}getTarget(){return this.getPositionedCharacters().reduce(((e,t)=>t.character.defence<e[0]?[t.character.defence,t.character.id]:e),[500,{}])[1]}setDamage(e,t,a){const s=Math.trunc(Math.max(t-this[`teamMember${e}`].character.defence,.1*t));this[`teamMember${e}`].character.health-=s,this[`teamMember${e}`].character.health<=0?(a(!0),delete this[`teamMember${e}`]):a(!1)}teamLevelUp(){const e=[];return Object.values(this).forEach((t=>{t.character.levelUp(),e.push(t.character)})),{characters:e}}getScore(){let e=0;return Object.values(this).forEach((t=>{e+=t.character.attack+t.character.defence})),Math.floor(e)}hasIndex(e){return Object.values(this).some((t=>e===t.position))}}class P{constructor(e){for(let t=0;t<e.length;t+=1){const{character:s}=e[t];Object.prototype.hasOwnProperty.call(s,"id")?Object.setPrototypeOf(s,a.prototype):s.id=t+11,this[`teamMember${s.id}`]={character:s,position:e[t].position}}}getPositionedCharacters(){const e=[];return Object.values(this).forEach((t=>{e.push(new o(t.character,t.position))})),e}setDamage(e,t,a){const s=Math.trunc(Math.max(t-this[`teamMember${e}`].character.defence,.1*t));this[`teamMember${e}`].character.health-=s,this[`teamMember${e}`].character.health<=0&&(a(this[`teamMember${e}`].character.defence),delete this[`teamMember${e}`])}setNewPosition(e,t){Object.keys(this).forEach((a=>{+this[a].character.id==+e&&(this[a].position=t)}))}getAtteckerId(){const e=this.getPositionedCharacters().filter((e=>"daemon"===e.character.type)),t=this.getPositionedCharacters().filter((e=>"vampire"===e.character.type)),a=this.getPositionedCharacters().filter((e=>"undead"===e.character.type));let s;return s=0===e.length&&0===t.length?a:0===e.length&&0!==t.length?t:e,s.reduce(((e,t)=>t.character.attack>e[0]?[t.character.attack,t.character.id]:e),[0,{}])[1]}static teamLevelUp(e,t){let a;return a=d([i,l,h],e<3?2:1,t),{characters:a.characters.map((t=>{const a=t;let s=1;return 3===e&&(s=1.5,a.health=100),4===e&&(s=2,a.health=100),a.attack*=s,a.defence*=s,a.level=e,a}))}}hasIndex(e){return Object.values(this).some((t=>e===t.position))}}function v(e,t){return e.concat(t)}class C{constructor(){this.ownTeam={},this.enemyTeam={},this.selectIndex=null,this.activePlayer=0,this.round=1,this.score=0,this.theme=null,this.indexAutoAttack=null,this.indexAutoAttacker=null,this.enemysLastTarget=null,this.gameBlocking=!1}static maxScore=0;getPositionedCharacter(e){return this.ownTeam.hasIndex(e)?Object.values(this.ownTeam).find((t=>e===t.position)):this.enemyTeam.hasIndex(e)?Object.values(this.enemyTeam).find((t=>e===t.position)):null}getSelectPositionedCharacter(){return this.getPositionedCharacter(this.selectIndex)}from(e){this.ownTeam=new p(e.ownPositionedCharacters),this.enemyTeam=new P(e.enemyPositionedCharacters),this.selectIndex=e.selectIndex,this.activePlayer=e.activePlayer,this.round=e.round,this.score=e.score,this.theme=e.theme,C.maxScore=e.maxScore,this.indexAutoAttack=e.indexAutoAttack,this.indexAutoAttacker=e.indexAutoAttacker,this.enemysLastTarget=e.enemysLastTarget,this.gameBlocking=e.gameBlocking}getData(){return{ownPositionedCharacters:this.ownTeam.getPositionedCharacters(),enemyPositionedCharacters:this.enemyTeam.getPositionedCharacters(),selectIndex:this.selectIndex,activePlayer:this.activePlayer,round:this.round,score:this.score,theme:this.theme,maxScore:C.maxScore,indexAutoAttack:this.indexAutoAttack,indexAutoAttacker:this.indexAutoAttacker,enemysLastTarget:this.enemysLastTarget,gameBlocking:this.gameBlocking}}setMaxScore(){this.score>C.maxScore&&(C.maxScore=this.score)}addPoints(e){this.score+=Math.floor(e)}}class f{constructor(e){this.boardSize=e;const t=[];for(let e=0;e<this.boardSize;e+=1){t[e]=[];for(let a=0;a<this.boardSize;a+=1)t[e][a]=a+e*this.boardSize}this.arrayIndexes=t}getIndexes(e){for(let t=0;t<this.boardSize;t+=1)for(let a=0;a<this.boardSize;a+=1)if(this.arrayIndexes[t][a]===e)return[t,a]}}var x={prairie:"prairie",desert:"desert",arctic:"arctic",mountain:"mountain"};class k{constructor(e,t){this.gamePlay=e,this.stateService=t,this.countCharacterInTeam=4,this.gameState={}}init(){this.gameState=new C,this.setTheme();const e=d([s,n,r],2,this.countCharacterInTeam),t=d([i,l,h],2,this.countCharacterInTeam);this.gameState.ownTeam=new p(m(e,[0,1,8,9,16,17,24,25,32,33,40,41,48,49,56,57])),this.gameState.enemyTeam=new P(m(t,[6,7,14,15,22,23,30,31,38,39,46,47,54,55,62,63])),this.gamePlay.redrawPositions(v(this.gameState.ownTeam.getPositionedCharacters(),this.gameState.enemyTeam.getPositionedCharacters())),this.gamePlay.addCellEnterListener((e=>this.onCellEnter(e))),this.gamePlay.addCellLeaveListener((e=>this.onCellLeave(e))),this.gamePlay.addCellClickListener((e=>this.onCellClick(e))),this.gamePlay.addCellDblClickListener((e=>this.onCellDblClick(e))),this.gamePlay.addNewGameListener((()=>this.startNewGame())),this.gamePlay.addSaveGameListener((()=>this.saveGame())),this.gamePlay.addLoadGameListener((()=>this.loadGame())),this.gamePlay.addPopupClosedListener((()=>this.onPopupClosed())),this.showInfo(),this.gameState.activePlayer=0,this.play()}setTheme(){let{theme:e}=this.gameState;if(e){let t=Object.values(x).findIndex((e=>e===this.gameState.theme));t>=Object.values(x).length-1&&(t=-1),e=Object.values(x)[t+1]}else[e]=Object.values(x);this.gameState.theme=e,this.gamePlay.drawUi(e)}play(){if(!this.gameState.enemyTeam.getPositionedCharacters().length){if(4===this.gameState.round)return t.showMessage("вы выиграли игру"),this.gameState.setMaxScore(),this.showInfo(),void this.blockGame();this.gameState.addPoints(this.gameState.ownTeam.getScore()),this.startNewRound()}if(!this.gameState.ownTeam.getPositionedCharacters().length)return t.showMessage("вы проиграли"),void this.blockGame();1!==this.gameState.activePlayer?0===this.gameState.activePlayer&&null!==this.gameState.indexAutoAttack&&this.checkAttack(this.gameState.indexAutoAttack):this.reactEnemy()}onCellClick(e){if(null!=e){if(null!==this.gameState.selectIndex&&this.gamePlay.deselectCell(this.gameState.selectIndex),this.gameState.ownTeam.hasIndex(e))return this.gamePlay.selectCell(e),void(this.gameState.selectIndex=e);if(this.gameState.ownTeam.hasIndex(this.gameState.selectIndex)){if(!this.gameState.ownTeam.hasIndex(e)&&!this.gameState.enemyTeam.hasIndex(e)&&this.getIndexesMoveAndAttack(this.gameState.selectIndex).arrayMoveIndexes.includes(e))return void this.move(e);if(this.gameState.enemyTeam.hasIndex(e)&&this.getIndexesMoveAndAttack(this.gameState.selectIndex).arrayAttackIndexes.includes(e))return void this.attack(e)}t.showError("Не правильный выбор!")}}onCellDblClick(e){null!=e&&(this.gameState.indexAutoAttack=e,this.gameState.indexAutoAttacker=this.gameState.selectIndex,this.play())}onCellEnter(e){if(null!=e&&1!==this.gameState.activePlayer)if(this.gameState.ownTeam.hasIndex(e)||this.gameState.enemyTeam.hasIndex(e)){const t=this.gamePlay.cells[e].querySelector(".character"),a=k.showInformation(t);this.gamePlay.showCellTooltip(a,e),this.gameState.ownTeam.hasIndex(e)?(this.showAttackAndMovementBoundaries(e),this.gameState.selectIndex!==e&&this.gamePlay.setCursor(u)):null!==this.gameState.selectIndex&&this.gameState.enemyTeam.hasIndex(e)?this.getIndexesMoveAndAttack(this.gameState.selectIndex).arrayAttackIndexes.includes(e)?(this.gamePlay.setCursor(y),this.gamePlay.selectCell(e,"red")):this.gamePlay.setCursor(S):this.gamePlay.setCursor(g)}else null!==this.gameState.selectIndex?this.getIndexesMoveAndAttack(this.gameState.selectIndex).arrayMoveIndexes.includes(e)?(this.gamePlay.setCursor(u),this.gamePlay.selectCell(e,"green")):this.gamePlay.setCursor(S):this.gamePlay.setCursor(g)}onCellLeave(e){null!=e&&((this.gameState.ownTeam.hasIndex(e)||this.gameState.enemyTeam.hasIndex(e))&&(this.gamePlay.hideCellTooltip(e),this.gameState.ownTeam.hasIndex(e)&&this.hideAttackAndMovementBoundaries()),this.gamePlay.setCursor(g),this.gameState.selectIndex===e&&this.gameState.ownTeam.hasIndex(e)||this.gamePlay.deselectCell(e))}onPopupClosed(){this.gamePlay.hidePopup()}static showInformation(e){return`🎖${e.dataset.level} ⚔${e.dataset.attack} 🛡${e.dataset.defence} ❤${e.dataset.health}`}move(e){const t=this.gamePlay.cells[this.gameState.selectIndex].querySelector(".character").dataset.id,a=function*(e){const a=new f(this.gamePlay.boardSize),{arrayIndexes:s}=new f(this.gamePlay.boardSize);let[i,r]=a.getIndexes(this.gameState.selectIndex);const[n,l]=a.getIndexes(e),h=n-i,c=l-r,o=Math.max(Math.abs(c),Math.abs(h));for(let e=0;e<o;e+=1){const e=Math.trunc(i+h/o),a=Math.trunc(r+c/o);e>=0&&e<this.gamePlay.boardSize&&a>=0&&a<this.gamePlay.boardSize&&(i=e,r=a),0===this.gameState.activePlayer&&(this.gameState.ownTeam.setNewPosition(t,s[i][r]),yield this.gameState.ownTeam.getPositionedCharacters()),1===this.gameState.activePlayer&&(this.gameState.enemyTeam.setNewPosition(t,s[i][r]),yield this.gameState.enemyTeam.getPositionedCharacters())}}.call(this,e);let s;const i=()=>{setTimeout((()=>{s=a.next(),s.done?(this.gameState.selectIndex=null,this.gamePlay.deselectCell(e),this.gameState.activePlayer=0===this.gameState.activePlayer?1:0,this.play()):(0===this.gameState.activePlayer&&this.gamePlay.redrawPositions(v(s.value,this.gameState.enemyTeam.getPositionedCharacters())),1===this.gameState.activePlayer&&this.gamePlay.redrawPositions(v(this.gameState.ownTeam.getPositionedCharacters(),s.value)),i())}),50)};i()}attack(e){const{attack:t}=this.gamePlay.cells[this.gameState.selectIndex].querySelector(".character").dataset;this.gamePlay.selectCell(this.gameState.selectIndex),this.gamePlay.selectCell(e,"red"),this.gamePlay.showDamage(e,t).then((()=>{0===this.gameState.activePlayer&&(this.gameState.enemyTeam.setDamage(this.gamePlay.cells[e].querySelector(".character").dataset.id,t,(e=>{this.gameState.addPoints(e)})),this.showInfo(),this.gamePlay.redrawPositions(v(this.gameState.ownTeam.getPositionedCharacters(),this.gameState.enemyTeam.getPositionedCharacters()))),1===this.gameState.activePlayer&&(this.gameState.enemysLastTarget=e,this.gameState.ownTeam.setDamage(this.gamePlay.cells[e].querySelector(".character").dataset.id,t,(e=>{e&&(this.gameState.enemysLastTarget="killed")})),this.gamePlay.redrawPositions(v(this.gameState.ownTeam.getPositionedCharacters(),this.gameState.enemyTeam.getPositionedCharacters()))),this.gamePlay.deselectCell(this.gameState.selectIndex),this.gamePlay.deselectCell(e),this.gameState.selectIndex=null,this.gameState.activePlayer=0===this.gameState.activePlayer?1:0,this.play()}))}reactEnemy(){const e=this.gameState.ownTeam.getTarget(),t=this.gamePlay.boardEl.querySelector(`[data-id="${e}"]`),a=this.gamePlay.cells.indexOf(t.closest(".cell")),s=this.gameState.enemyTeam.getAtteckerId(),i=this.gamePlay.boardEl.querySelector(`[data-id="${s}"]`),r=this.gamePlay.cells.indexOf(i.closest(".cell"));this.gameState.selectIndex=r,this.getIndexesMoveAndAttack(r).arrayAttackIndexes.includes(a)?this.attack(a,i.attack):this.chooseDirection(a)}chooseDirection(e){const t=new f(this.gamePlay.boardSize),{arrayIndexes:a}=new f(this.gamePlay.boardSize),[s,i]=t.getIndexes(e),[r,n]=t.getIndexes(this.gameState.selectIndex),l=this.gameState.getSelectPositionedCharacter().character.charAttackRange;let h=Math.sign(s-r),c=Math.sign(i-n);const o=this.gameState.getSelectPositionedCharacter().character.charHikeRange,d=function*(e,t){e&&t&&(yield[0,t],yield[e,0],yield[-1*e,t],yield[e,-1*t]),e&&!t&&(yield[e,-1],yield[e,1],yield[0,-1],yield[0,1]),!e&&t&&(yield[-1,t],yield[1,t],yield[-1,0],yield[1,0])}(h,c);let m,g=r,u=n;for(let t=0;t<o&&(g+=h,u+=c,!(g>=0&&g<this.gamePlay.boardSize&&u>=0&&u<this.gamePlay.boardSize&&(m=t+1,this.getIndexesMoveAndAttack(a[g][u],l).arrayAttackIndexes.includes(e))));t+=1);for(;this.gameState.getPositionedCharacter(a[r+h*m][n+c*m]);){if(1===m){const e=d.next().value,[t,a]=e,s=r+t*m,i=n+a*m;s>=0&&s<this.gamePlay.boardSize&&i>=0&&i<this.gamePlay.boardSize&&([h,c]=[t,a])}m>1&&(m-=1)}const y=a[r+h*m][n+c*m];this.move(y)}getIndexesMoveAndAttack(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;const a=new f(this.gamePlay.boardSize),s=a.arrayIndexes,[i,r]=a.getIndexes(e),n=[];if(!t){const t=this.gameState.getPositionedCharacter(e).character.charHikeRange;for(let e=1;e<=t;e+=1)n.push(s[i][r-e]),n.push(s[i][r+e]),i-e>=0&&(n.push(s[i-e][r]),n.push(s[i-e][r-e]),n.push(s[i-e][r+e])),i+e<s.length&&(n.push(s[i+e][r]),n.push(s[i+e][r+e]),n.push(s[i+e][r-e]))}const l=t||this.gameState.getPositionedCharacter(e).character.charAttackRange,h=[],c=i-l<0?0:i-l,o=r-l<0?0:r-l,d=i+l>=s.length?s.length-1:i+l,m=r+l>=s.length?s.length-1:r+l;for(let e=c;e<=d;e+=1)for(let t=o;t<=m;t+=1)h.push(s[e][t]);return{arrayMoveIndexes:n.filter((e=>void 0!==e)),arrayAttackIndexes:h}}checkAttack(e){this.gameState.selectIndex=this.gameState.indexAutoAttacker;const t=this.gameState.getPositionedCharacter(e),a=this.gameState.getSelectPositionedCharacter();if(null===t||!this.gameState.enemyTeam.hasIndex(e)||null===a||"killed"===this.gameState.enemysLastTarget)return this.gameState.indexAutoAttack=null,this.gameState.indexAutoAttacker=null,this.gameState.enemysLastTarget=null,void(this.gameState.selectIndex=null);this.attack(e)}startNewRound(){this.gameState.round+=1,this.setTheme(),this.gameState.ownTeam=new p(m(this.gameState.ownTeam.teamLevelUp(),[0,1,8,9,16,17,24,25,32,33,40,41,48,49,56,57])),this.gameState.enemyTeam=new P(m(P.teamLevelUp(this.gameState.round,this.countCharacterInTeam),[6,7,14,15,22,23,30,31,38,39,46,47,54,55,62,63])),this.gamePlay.redrawPositions(v(this.gameState.ownTeam.getPositionedCharacters(),this.gameState.enemyTeam.getPositionedCharacters())),this.showInfo(),this.gameState.activePlayer=0}blockGame(){this.gamePlay.cellEnterListeners=[],this.gamePlay.cellLeaveListeners=[],this.gamePlay.cellClickListeners=[],this.gamePlay.addCellDblClickListener((()=>{})),this.gameState.gameBlocking=!0}unBlockGame(){0===this.gamePlay.cellEnterListeners.length&&this.gamePlay.addCellEnterListener((e=>this.onCellEnter(e))),0===this.gamePlay.cellLeaveListeners.length&&this.gamePlay.addCellLeaveListener((e=>this.onCellLeave(e))),0===this.gamePlay.cellClickListeners.length&&this.gamePlay.addCellClickListener((e=>this.onCellClick(e))),this.gamePlay.addCellDblClickListener((e=>this.onCellDblClick(e))),this.gameState.gameBlocking=!1}startNewGame(){this.gamePlay=new t,this.gamePlay.bindToDOM(document.querySelector("#game-container")),this.init()}saveGame(){this.gameState.gameBlocking?t.showMessage("сейчас невозможно сохранить игру"):this.stateService.save(this.gameState.getData())}loadGame(){try{this.gameState.gameBlocking&&this.unBlockGame(),this.gameState.from(this.stateService.load()),this.gamePlay.drawUi(this.gameState.theme),this.gamePlay.redrawPositions(v(this.gameState.ownTeam.getPositionedCharacters(),this.gameState.enemyTeam.getPositionedCharacters())),this.showInfo()}catch(e){t.showError(e.message)}}showInfo(){this.gamePlay.scoreEl.textContent=`Score: ${this.gameState.score}`,this.gamePlay.maxScoreEl.textContent=`MaxScore: ${C.maxScore}`,this.gamePlay.roundEl.textContent=`Round: ${this.gameState.round}`}showAttackAndMovementBoundaries(e){const t=this.getIndexesMoveAndAttack(e).arrayMoveIndexes,a=this.getIndexesMoveAndAttack(e).arrayAttackIndexes;t.forEach((e=>{this.gamePlay.cells[e].classList.add("move")})),a.forEach((e=>{const t=function(e,t,a){const s=Math.min(...t),i=Math.max(...t);if(e===s)return"top-left";if(e===i)return"bottom-right";let r=s+a;for(;r<i-a;){if(e===r)return"left";r+=a}const n=r;if(e===n)return"bottom-left";for(r=i-a;r>s+a;){if(e===r)return"right";r-=a}return e===r?"top-right":e>s&&e<r?"top":e>n&&e<i?"bottom":void 0}(e,a,this.gamePlay.boardSize);t&&this.gamePlay.cells[e].classList.add("border",`border-${t}`)}))}hideAttackAndMovementBoundaries(){this.gamePlay.cells.forEach((e=>{e.classList.remove("move"),e.classList.remove("border");const t=[...e.classList].find((e=>e.startsWith("border-")));t&&e.classList.remove(t)}))}}const w=new t;w.bindToDOM(document.querySelector("#game-container"));const L=new class{constructor(e){this.storage=e}save(e){this.storage.setItem("state",JSON.stringify(e))}load(){try{return JSON.parse(this.storage.getItem("state"))}catch(e){throw new Error("Invalid state")}}}(localStorage);new k(w,L).init()}();